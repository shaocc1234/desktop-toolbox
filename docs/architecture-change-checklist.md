# 架构变更检查清单

## 🎯 使用说明

本检查清单适用于任何可能影响系统架构的变更，包括但不限于：
- UI组件迁移（如API密钥输入框从一个页面移动到另一个页面）
- 数据流重构
- 配置管理方式变更
- 接口定义修改

**使用方法**：在进行架构变更时，逐项检查并在完成后打勾确认。

---

## 📋 变更前准备阶段

### 1. 影响范围分析
- [ ] **识别所有相关文件**
  ```bash
  # 搜索相关标识符
  grep -r "旧标识符" . --include="*.js" --include="*.ejs" --include="*.html"
  grep -r "相关函数名" . --include="*.js"
  ```
- [ ] **列出所有数据流路径**
  - [ ] 数据输入点（表单、API等）
  - [ ] 数据传递路径（参数、全局变量等）
  - [ ] 数据存储位置（localStorage、数据库等）
  - [ ] 数据使用位置（显示、处理等）
- [ ] **确认依赖关系**
  - [ ] 哪些模块依赖当前功能
  - [ ] 当前功能依赖哪些模块
  - [ ] 是否有循环依赖

### 2. 风险评估
- [ ] **评估变更复杂度**
  - [ ] 低风险：单文件内部重构
  - [ ] 中风险：跨文件但同模块变更
  - [ ] 高风险：跨模块或跨页面变更
- [ ] **识别潜在问题点**
  - [ ] DOM元素ID变更
  - [ ] 函数签名变更
  - [ ] 数据格式变更
  - [ ] 配置结构变更

### 3. 备份和版本控制
- [ ] **创建功能分支**
  ```bash
  git checkout -b feature/architecture-change-description
  ```
- [ ] **记录当前状态**
  - [ ] 截图当前功能界面
  - [ ] 记录当前数据流
  - [ ] 备份关键配置文件

---

## 🔧 变更执行阶段

### 1. 数据模型变更
- [ ] **更新数据结构定义**
  - [ ] 前端数据模型
  - [ ] 后端数据模型
  - [ ] 数据库schema（如适用）
- [ ] **更新接口定义**
  - [ ] API请求格式
  - [ ] API响应格式
  - [ ] 内部函数接口

### 2. 后端逻辑更新
- [ ] **更新数据处理逻辑**
  - [ ] 数据验证规则
  - [ ] 数据转换逻辑
  - [ ] 存储逻辑
- [ ] **更新API端点**
  - [ ] 请求参数处理
  - [ ] 响应数据格式
  - [ ] 错误处理

### 3. 前端逻辑更新
- [ ] **更新数据获取逻辑**
  ```javascript
  // 检查点：确保数据获取方式一致
  // 旧方式：document.getElementById('apiKey')?.value
  // 新方式：this.globalConfig.apiKey
  ```
- [ ] **更新数据传递逻辑**
  - [ ] 函数调用参数
  - [ ] 事件传递数据
  - [ ] 全局状态更新
- [ ] **更新UI交互逻辑**
  - [ ] 事件监听器绑定
  - [ ] DOM操作逻辑
  - [ ] 表单处理逻辑

### 4. 配置和常量更新
- [ ] **更新配置文件**
  - [ ] 环境配置
  - [ ] 默认值设置
  - [ ] 路径配置
- [ ] **更新常量定义**
  - [ ] DOM元素ID
  - [ ] API端点路径
  - [ ] 配置键名

---

## ✅ 变更验证阶段

### 1. 代码静态检查
- [ ] **语法检查**
  ```bash
  npm run lint
  ```
- [ ] **类型检查**（如使用TypeScript）
  ```bash
  npm run type-check
  ```
- [ ] **依赖检查**
  - [ ] 所有import/require语句正确
  - [ ] 所有函数调用参数匹配
  - [ ] 所有DOM元素ID存在

### 2. 单元测试
- [ ] **更新现有测试**
  - [ ] 修改受影响的测试用例
  - [ ] 更新测试数据
  - [ ] 更新断言条件
- [ ] **添加新测试**
  - [ ] 新功能的测试用例
  - [ ] 边界条件测试
  - [ ] 错误处理测试

### 3. 集成测试
- [ ] **API接口测试**
  ```javascript
  // 测试示例
  describe('API Key Integration', () => {
    it('should pass API key from settings to processing', async () => {
      // 测试完整数据流
    });
  });
  ```
- [ ] **跨模块交互测试**
  - [ ] 页面间数据传递
  - [ ] 组件间通信
  - [ ] 服务间调用

### 4. 端到端测试
- [ ] **用户场景测试**
  - [ ] 完整的用户操作流程
  - [ ] 多种使用场景
  - [ ] 异常情况处理
- [ ] **浏览器兼容性测试**
  - [ ] 主流浏览器测试
  - [ ] 移动端测试（如适用）
  - [ ] 不同屏幕尺寸测试

---

## 🔍 质量保证阶段

### 1. 代码审查
- [ ] **自我审查**
  - [ ] 检查所有TODO和FIXME
  - [ ] 确认代码风格一致
  - [ ] 验证注释准确性
- [ ] **同行审查**（如适用）
  - [ ] 代码逻辑正确性
  - [ ] 架构设计合理性
  - [ ] 性能影响评估

### 2. 性能测试
- [ ] **响应时间测试**
  - [ ] API响应时间
  - [ ] 页面加载时间
  - [ ] 用户交互响应时间
- [ ] **资源使用测试**
  - [ ] 内存使用情况
  - [ ] CPU使用情况
  - [ ] 网络请求数量

### 3. 安全检查
- [ ] **数据安全**
  - [ ] 敏感数据加密
  - [ ] 输入数据验证
  - [ ] 输出数据过滤
- [ ] **访问控制**
  - [ ] 权限验证
  - [ ] 身份认证
  - [ ] 会话管理

---

## 📚 文档更新阶段

### 1. 技术文档
- [ ] **API文档更新**
  - [ ] 接口定义
  - [ ] 参数说明
  - [ ] 示例代码
- [ ] **架构文档更新**
  - [ ] 系统架构图
  - [ ] 数据流图
  - [ ] 组件关系图

### 2. 用户文档
- [ ] **使用说明更新**
  - [ ] 功能操作步骤
  - [ ] 配置说明
  - [ ] 常见问题解答
- [ ] **变更日志**
  - [ ] 新增功能说明
  - [ ] 变更内容描述
  - [ ] 影响范围说明

### 3. 开发文档
- [ ] **代码注释更新**
  ```javascript
  /**
   * 获取API密钥
   * 注意：API密钥现在统一在全局设置中管理
   * 数据流：设置页面 -> localStorage -> globalConfig -> 这里
   */
  ```
- [ ] **开发指南更新**
  - [ ] 新的开发流程
  - [ ] 注意事项
  - [ ] 最佳实践

---

## 🚀 部署准备阶段

### 1. 部署前检查
- [ ] **环境配置检查**
  - [ ] 开发环境测试通过
  - [ ] 测试环境部署成功
  - [ ] 生产环境配置准备
- [ ] **数据迁移准备**（如需要）
  - [ ] 迁移脚本准备
  - [ ] 数据备份计划
  - [ ] 回滚方案准备

### 2. 监控和日志
- [ ] **添加监控指标**
  - [ ] 关键功能监控
  - [ ] 性能指标监控
  - [ ] 错误率监控
- [ ] **完善日志记录**
  - [ ] 关键操作日志
  - [ ] 错误日志
  - [ ] 调试日志

### 3. 回滚计划
- [ ] **制定回滚策略**
  - [ ] 回滚触发条件
  - [ ] 回滚操作步骤
  - [ ] 数据恢复方案
- [ ] **验证回滚可行性**
  - [ ] 回滚脚本测试
  - [ ] 数据恢复测试
  - [ ] 功能验证测试

---

## 📝 变更记录模板

```markdown
## 变更记录

**变更日期**: YYYY-MM-DD
**变更类型**: 架构重构/功能迁移/接口变更
**影响范围**: 前端/后端/全栈

### 变更描述
- 变更内容简述
- 变更原因说明
- 预期效果描述

### 影响的文件
- [ ] `path/to/file1.js` - 变更内容
- [ ] `path/to/file2.ejs` - 变更内容

### 测试结果
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 端到端测试通过

### 已知问题
- 问题描述1 - 解决方案/计划
- 问题描述2 - 解决方案/计划

### 后续计划
- [ ] 待完成任务1
- [ ] 待完成任务2
```

---

**重要提醒**：
1. 每个检查项都必须完成后才能进入下一阶段
2. 如发现问题，必须解决后才能继续
3. 保持详细的变更记录，便于后续维护和问题排查
4. 当有疑问时，优先选择保守和安全的方案
