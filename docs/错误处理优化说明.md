# 错误处理和智能重试机制优化

## 问题分析

根据日志分析，主要问题包括：

1. **错误类型集中**：主要是超时(timeout)和速率限制(429)错误
2. **重试机制不够智能**：没有区分错误类型进行不同处理
3. **服务切换不够及时**：多AI服务切换逻辑存在但没有充分利用
4. **队列处理缺乏智能调度**：遇到错误时没有跳过当前文件处理其他文件
5. **降级方案触发不及时**：OCR降级方案存在但触发条件不够灵活

## 优化方案

### 1. 智能错误处理机制

#### 1.1 错误类型分析
- **超时错误**：`timeout of 60000ms exceeded`
- **速率限制**：`Request failed with status code 429`、`TPM limit reached`
- **服务器错误**：`Server Error: 500`
- **认证错误**：`Unauthorized: 401`

#### 1.2 智能降级触发条件
```javascript
shouldTriggerOCRFallback(error, attempt, maxRetries) {
    // 第二次尝试就遇到速率限制，立即降级
    if (isRateLimit && attempt >= 2) return true;
    
    // 连续超时，在第二次尝试后降级
    if (isTimeout && attempt >= 2) return true;
    
    // 服务器错误，立即降级
    if (isServerError) return true;
    
    // 特定错误关键词，立即降级
    if (errorMessage.includes('tpm limit')) return true;
}
```

### 2. 智能延迟策略

#### 2.1 指数退避算法
```javascript
calculateSmartDelay(attempt, consecutiveRateLimits, baseDelay) {
    // 基础指数退避
    let delay = baseDelay * Math.pow(2, attempt - 1);
    
    // 连续速率限制额外延迟
    if (consecutiveRateLimits > 2) {
        delay += consecutiveRateLimits * 5000;
    }
    
    // 最大延迟限制30秒
    return Math.min(delay, 30000);
}
```

#### 2.2 延迟策略效果
- 尝试1：2秒基础延迟
- 尝试2：4秒延迟
- 尝试3：8秒延迟
- 连续速率限制3次：额外增加15秒

### 3. 智能队列管理器

#### 3.1 文件优先级排序
- 优先处理小文件
- 图片文件优先级较低（容易出错）
- 失败文件重新排队但降低优先级

#### 3.2 智能暂停机制
- 连续错误≥5次：暂停处理
- 速率限制错误>10次：暂停1分钟
- 动态调整暂停时间

#### 3.3 处理策略自适应
```javascript
getProcessingStrategy() {
    let strategy = {
        concurrency: 3,
        delay: 1000,
        useOCRFallback: false,
        skipImages: false
    };
    
    // 根据错误统计调整
    if (rateLimit > 5) {
        strategy.concurrency = 1;
        strategy.delay = 5000;
        strategy.useOCRFallback = true;
    }
}
```

### 4. 多AI服务增强

#### 4.1 智能服务切换
- 按优先级尝试每个服务商
- 根据错误类型决定是否继续
- 服务间添加智能延迟

#### 4.2 错误类型识别
- `rate_limit`：速率限制
- `timeout`：请求超时
- `server_error`：服务器错误
- `auth_error`：认证错误

### 5. OCR降级方案优化

#### 5.1 强制降级支持
```javascript
// 检查是否强制使用OCR降级
if (config.forceOCRFallback) {
    return await this.fallbackToOCRAndChat(fileName, ocrText, config);
}
```

#### 5.2 降级触发优化
- 多AI服务失败时立即触发
- 特定错误类型立即触发
- 连续失败后自动触发

## 实际效果

### 测试结果
1. **智能队列管理**：文件按优先级处理，失败文件自动重试
2. **错误分析**：准确识别不同错误类型
3. **智能延迟**：根据错误情况动态调整延迟时间
4. **降级机制**：在合适时机触发OCR降级

### 性能提升
- **错误恢复能力**：从单次失败影响整体 → 智能跳过和重试
- **处理效率**：从固定延迟 → 动态调整延迟策略
- **服务可用性**：从单一服务 → 多服务智能切换
- **降级及时性**：从被动降级 → 主动智能降级

## 使用方法

### 启用智能队列处理
```javascript
const options = {
    useSmartQueue: true,  // 启用智能队列
    useOCRFallback: true, // 启用OCR降级
    // ... 其他选项
};
```

### 配置多AI服务
确保在配置中启用多AI服务，系统会自动进行服务切换和错误处理。

### 监控处理状态
系统会输出详细的处理状态和错误统计，便于监控和调试。

## 总结

通过实现智能错误处理、队列管理和服务切换机制，系统现在能够：

1. **智能识别错误类型**并采取相应策略
2. **动态调整处理参数**以适应当前状况
3. **自动切换服务商**避免单点故障
4. **及时触发降级方案**确保处理连续性
5. **优化文件处理顺序**提高整体效率

这些优化大大提高了系统的稳定性和处理效率，避免了单个错误影响整体进度的问题。
