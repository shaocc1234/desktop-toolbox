<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片处理 - 图库上传工具</title>

    <%- include('partials/app-init') %>

    <!-- Bootstrap CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 左侧侧边栏 -->
        <div class="sidebar bg-light border-end" id="sidebar">
            <%- include('partials/sidebar') %>
        </div>

        <!-- 右侧主内容区 -->
        <div class="main-content" id="main-content">
            <main class="p-4">
                    <div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-magic text-primary me-2"></i>
                图片处理工具
            </h1>
            <p class="text-muted mb-0">批量压缩、格式转换、尺寸调整</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="clearAllBtn">
                <i class="bi bi-trash me-1"></i>清空队列
            </button>
            <button class="btn btn-primary" id="processAllBtn" disabled>
                <i class="bi bi-play-circle me-1"></i>开始处理
            </button>
        </div>
    </div>

    <div class="row">
        <!-- 左侧：文件选择和处理选项 -->
        <div class="col-lg-4 mb-4">
            <!-- 文件选择区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-folder-plus me-2"></i>选择文件
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 文件选择按钮 -->
                    <div class="d-grid gap-2 mb-3">
                        <input type="file" id="fileInput" multiple accept="image/*" class="d-none">
                        <input type="file" id="folderInput" webkitdirectory directory multiple class="d-none">
                        <button class="btn btn-outline-primary" id="selectFilesBtn">
                            <i class="bi bi-file-earmark-image me-2"></i>选择图片文件
                        </button>
                        <button class="btn btn-outline-secondary" id="selectFolderBtn">
                            <i class="bi bi-folder2-open me-2"></i>选择文件夹
                        </button>
                    </div>
                    
                    <!-- 文件夹扫描选项 -->
                    <div class="mb-3" id="folderOptions" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSubfolders" checked>
                            <label class="form-check-label" for="includeSubfolders">
                                包含子文件夹
                            </label>
                        </div>
                        <small class="text-muted">递归扫描所有子目录中的图片文件</small>
                    </div>
                    
                    <!-- 拖拽上传区域 -->
                    <div class="drop-zone border border-2 border-dashed rounded p-4 text-center" id="dropZone">
                        <i class="bi bi-cloud-upload display-4 text-muted mb-2"></i>
                        <p class="text-muted mb-0">拖拽图片文件或文件夹到这里</p>
                        <small class="text-muted">支持 JPG、PNG、WebP、GIF 等格式<br>文件夹将自动扫描图片文件</small>
                    </div>
                </div>
            </div>

            <!-- 处理选项 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-sliders me-2"></i>处理选项
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 压缩质量 -->
                    <div class="mb-4">
                        <label class="form-label">压缩质量</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="range" class="form-range" id="qualityRange" min="1" max="100" value="80">
                            <span class="badge bg-primary" id="qualityValue">80%</span>
                        </div>
                        <div class="form-text">
                            <small>推荐：网页用 70-80%，打印用 90%+</small>
                        </div>
                    </div>

                    <!-- 输出格式 -->
                    <div class="mb-4">
                        <label class="form-label">输出格式</label>
                        <select class="form-select" id="formatSelect">
                            <option value="original">保持原格式</option>
                            <option value="jpeg">JPEG (通用格式)</option>
                            <option value="png">PNG (支持透明)</option>
                            <option value="webp">WebP (现代格式)</option>
                        </select>
                    </div>

                    <!-- 尺寸限制 -->
                    <div class="mb-4">
                        <label class="form-label">尺寸限制</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control" id="maxWidth" placeholder="最大宽度">
                                <div class="form-text"><small>像素</small></div>
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" id="maxHeight" placeholder="最大高度">
                                <div class="form-text"><small>像素</small></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="setPresetSize(1920, 1080)">1080P</button>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="setPresetSize(1280, 720)">720P</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSize()">清除</button>
                        </div>
                    </div>

                    <!-- 快速预设 -->
                    <div class="mb-4">
                        <label class="form-label">快速预设</label>
                        <div class="d-grid gap-1">
                            <button class="btn btn-sm btn-outline-info" onclick="applyPreset('web')">网页优化</button>
                            <button class="btn btn-sm btn-outline-info" onclick="applyPreset('social')">社交媒体</button>
                            <button class="btn btn-sm btn-outline-info" onclick="applyPreset('print')">打印用途</button>
                            <button class="btn btn-sm btn-outline-info" onclick="applyPreset('thumbnail')">缩略图</button>
                        </div>
                    </div>

                    <!-- 高级选项 -->
                    <div class="mb-3">
                        <label class="form-label">高级选项</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="removeMetadata">
                            <label class="form-check-label" for="removeMetadata">
                                移除元数据 (EXIF信息)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="progressive">
                            <label class="form-check-label" for="progressive">
                                渐进式编码
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：文件队列和处理结果 -->
        <div class="col-lg-8">
            <!-- 处理统计 -->
            <div class="card mb-4" id="statsCard" style="display: none;">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-primary" id="totalFiles">0</div>
                                <div class="stat-label">总文件数</div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-success" id="completedFiles">0</div>
                                <div class="stat-label">已完成</div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-info" id="originalSize">0 KB</div>
                                <div class="stat-label">原始大小</div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-success" id="estimatedSize">0 KB</div>
                                <div class="stat-label">预估处理后</div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-warning" id="savedSize">0 KB</div>
                                <div class="stat-label">节省空间</div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-secondary" id="compressionRatio">0%</div>
                                <div class="stat-label">压缩比例</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件队列 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>处理队列
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-success" id="saveAllBtn" disabled>
                            <i class="bi bi-download me-1"></i>批量保存
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 空状态 -->
                    <div class="empty-state text-center py-5" id="emptyState">
                        <i class="bi bi-images display-1 text-muted mb-3"></i>
                        <h5 class="text-muted">还没有选择图片</h5>
                        <p class="text-muted mb-0">点击上方按钮选择图片文件，或直接拖拽到页面上</p>
                    </div>

                    <!-- 文件列表 -->
                    <div class="file-list" id="fileList" style="display: none;">
                        <!-- 文件项将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 保存选项模态框 -->
<div class="modal fade" id="saveOptionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">保存选项</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">保存方式</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="saveMode" id="saveToFolder" value="folder" checked>
                        <label class="form-check-label" for="saveToFolder">
                            保存到文件夹
                        </label>
                        <div class="form-text"><small>选择文件夹批量保存（现代浏览器支持）</small></div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="saveMode" id="saveAsZip" value="zip">
                        <label class="form-check-label" for="saveAsZip">
                            保存成ZIP压缩包
                        </label>
                        <div class="form-text"><small>打包成ZIP文件下载（所有浏览器支持）</small></div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="saveMode" id="downloadIndividual" value="individual">
                        <label class="form-check-label" for="downloadIndividual">
                            逐个下载
                        </label>
                        <div class="form-text"><small>传统方式，逐个文件下载</small></div>
                    </div>
                    <div class="form-check" id="electronReplaceOption" style="display: none;">
                        <input class="form-check-input" type="radio" name="saveMode" id="replaceOriginal" value="replace">
                        <label class="form-check-label" for="replaceOriginal">
                            替换原文件 <span class="text-warning">(谨慎操作)</span>
                        </label>
                        <div class="form-text"><small>桌面应用专用：直接替换源文件</small></div>
                    </div>
                </div>
                
                <div id="saveAsOptions" style="display: none;">
                    <div class="mb-3">
                        <label for="filenameSuffix" class="form-label">文件名后缀</label>
                        <input type="text" class="form-control" id="filenameSuffix" value="_processed" placeholder="例如: _compressed">
                        <div class="form-text">将添加到原文件名后</div>
                    </div>
                    
                    <!-- ZIP打包选项 -->
                    <div class="mb-3" id="zipOptions" style="display: none;">
                        <label class="form-label">ZIP打包方式</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="zipStructure" id="zipFlat" value="flat" checked>
                            <label class="form-check-label" for="zipFlat">
                                平铺打包
                            </label>
                            <div class="form-text"><small>所有文件保存在ZIP根目录</small></div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="zipStructure" id="zipOriginal" value="original">
                            <label class="form-check-label" for="zipOriginal">
                                保持原文件结构
                            </label>
                            <div class="form-text"><small>按原始文件夹结构组织文件</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">开始保存</button>
            </div>
        </div>
    </div>
</div>

<style>
.drop-zone {
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover,
.drop-zone.drag-over {
    border-color: var(--bs-primary) !important;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

.file-item {
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.file-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.file-item.processing {
    border-color: var(--bs-primary);
    background-color: rgba(var(--bs-primary-rgb), 0.05);
}

.file-item.completed {
    border-color: var(--bs-success);
    background-color: rgba(var(--bs-success-rgb), 0.05);
}

.file-item.error {
    border-color: var(--bs-danger);
    background-color: rgba(var(--bs-danger-rgb), 0.05);
}

.stat-item {
    padding: 0.5rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--bs-secondary);
    margin-top: 0.25rem;
}

.progress-ring {
    width: 24px;
    height: 24px;
}

.progress-ring circle {
    fill: none;
    stroke: var(--bs-primary);
    stroke-width: 2;
    stroke-linecap: round;
    transform-origin: 50% 50%;
    transform: rotate(-90deg);
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spinner {
    animation: spin 1s linear infinite;
}
</style>

                    </div>
                </main>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastNotification" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong class="me-auto">提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- 消息内容 -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- 侧边栏管理 -->
    <script src="/js/sidebar.js"></script>
    <!-- 主题管理 -->
    <script src="/js/theme.js"></script>
    <!-- 通用工具 -->
    <script src="/js/utils.js"></script>
    <!-- 图片处理页面脚本 -->
    <script src="/js/process.js"></script>
</body>
</html>
